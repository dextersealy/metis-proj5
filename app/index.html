<!DOCTYPE html>
<html>
  <head>
    <link href='http://fonts.googleapis.com/css?family=Roboto:300,400,500' rel='stylesheet' type='text/css'>
    <link rel=stylesheet type=text/css href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.5/css/bootstrap.min.css" media="all">
    <title>Rental Report</title>
    <meta name="viewport" content="initial-scale=1.0">
    <meta charset="utf-8">
    <style>
      /* Always set the map height explicitly to define the size of the div
       * element that contains the map. */
      #map {
        width: 100%;
        height: 500px;
      }
      /* Optional: Makes the sample page fill the window. */
      html, body {
        margin: 0px;
        padding: 10px;
      }

      strong, label, h1, h2, h3, h4, h5, h6, .h1, .h2, .h3, .h4, .h5, .h6 {
        font-family:"Roboto",sans-serif;
        font-weight:500;
      }

      #l_latlng {
        font-size: 8pt;
        font-weight:300;
        text-align:right;
      }

      .bar rect {
        shape-rendering: crispEdges;
        fill: steelblue;
      }

      .bar text {
        fill: #999999;
      }

      .axis path, .axis line {
        fill: none;
        stroke: #000;
        shape-rendering: crispEdges;
      }

      .line {
        fill: none;
        stroke: darkorange;
        stroke-width: 3px;
      }

      .axis--grid .domain {
        fill: #ddd;
        stroke: none;
      }
      .axis--x .domain,
      .axis--grid .tick {
        stroke: #fff;
      }
      </style>
  </head>
  <body>
    <div class="container">
      <div class="row">
        <h1 style="margin-top: 10px;">Rent Report</h1>
      </div>
      <div class="row">
        <div class="col-md-6">
          <form class="form-horizontal" role="form">
            <div class="form-group">
              <label for="address"">Address:</label>
              <input id="address" class="form-control" type="textbox" placeholder="New York, NY">
            </div>
            <div class="form-group">
              <label >Bedrooms:</label>
              <div id="bedrooms">
                <button id="br" type="button" class="btn btn-secondary" onclick="on_select('br', '')">Any</button>
                <button id="br0" type="button" class="btn btn-secondary" onclick="on_select('br', '0')">Studio</button>
                <button id="br1" type="button" class="btn btn-secondary" onclick="on_select('br', '1')">One</button>
                <button id="br2" type="button" class="btn btn-secondary" onclick="on_select('br', '2')">Two</button>
                <button id="br3" type="button" class="btn btn-secondary" onclick="on_select('br', '3')">Three</button>
                <button id="br4" type="button" class="btn btn-secondary" onclick="on_select('br', '4')">Four or more</button>
              </div>
            </div>
            <div class="form-group">
              <label >Bathrooms:</label>
              <div>
                <button id="ba" type="button" class="btn btn-secondary" onclick="on_select('ba', '')">Any</button>
                <button id="ba1" type="button" class="btn btn-secondary" onclick="on_select('ba', '1')">1</button>
                <button id="ba1_5" type="button" class="btn btn-secondary" onclick="on_select('ba', '1_5')">1.5</button>
                <button id="ba2" type="button" class="btn btn-secondary" onclick="on_select('ba', '2')">2</button>
                <button id="ba2_5" type="button" class="btn btn-secondary" onclick="on_select('ba', '2_5')">2.5</button>
                <button id="ba3" type="button" class="btn btn-secondary" onclick="on_select('ba', '3')">3 or more</button>
              </div>
            </div>
            <div class="form-group">
              <button type="button" class="btn btn-primary" onclick="on_get_report()">Get Report
              </button>
            </div>
          </form>
          <div class="row">
            <div id="hist"></div>
          </div>
          <div class = "row">
            <div id="meter"></div>
          </div>
          <div class="row">
            <label id="l_matches"></label>
          </div>
        </div>
        <div class="col-md-6">
          <div id="map"></div>
          <div align="right">
            <label id="l_latlng"></label>
          </div>
        </div>
      </div>
    </div>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <script src="http://d3js.org/d3.v4.min.js"></script>
    <script src="/underscore-min.js"></script>
    <script src="/stringutils.js"></script>
    <script src="/mapstyle.js"></script>
    <script>
      var map = null;
      var auto_complete = null;
      var geocoder = null;
      var marker = null;
      var circle = null;
      var circle_params = { 
        strokeColor: '#0000FF', strokeOpacity: 0.8, strokeWeight: 1, fillColor: '#0000FF', fillOpacity: 0.15
      }
      var info_window = null;
      var place = null;

      var hist_svg = null;
      var meter_svg = null;

      var criteria = { loc: null, br : null, ba : null };
      var report = null;      

      /*  Set up the page */

      function init() {

        //  Create map and center it onTimes Square

        map = new google.maps.Map(document.getElementById('map'), {
          styles: map_style,
          center: {lat: 40.759, lng: -73.985},
          zoom: 13,
          draggableCursor: 'crosshair'
        });

        //  Set default bounds to five boroughs of New York

        var defaultBounds = new google.maps.LatLngBounds(
          new google.maps.LatLng(40.5, -74.2),
          new google.maps.LatLng(40.9, -73.7)
          );
        var options = {
          bounds: defaultBounds
        };

        //  Configure address auto-complete

        var input = document.getElementById("address");
        auto_complete = new google.maps.places.Autocomplete(input, options);
        google.maps.event.addListener(auto_complete, "place_changed", on_place_changed);

        //  Listen for events

        window.addEventListener("resize", on_resize); // window resize
        map.addListener('click', on_map_click); // map click
      }

      /*  Handle map click */

      function on_map_click(e) {
        
        //  Show coordinates

        var lat = round(e.latLng.lat(), 4);
        var lng = round(e.latLng.lng(), 4);
        document.getElementById("l_latlng").innerHTML = lat + ", " + lng;

        //  Show marker

        var marker = set_marker(e.latLng);

        //  Show info popup

        var latlng = {lat: lat, lng: lng};
        get_geocoder().geocode({"location" : latlng}, function(results, status) {
          var info_address = "";
          if (status == "OK") {
            if (results[0]) {
                document.getElementById("address").value = results[0].formatted_address;
                info_address = compose_address(results[0].address_components);
            } else {
              console.log("No results found");
            }
          } else {
            console.log("Geocoder failed:", status);
          }
          set_info_window(marker, info_address);
        });

        //  Show the report

        console.log(e.latLng);
        criteria.loc = e.latLng;
        get_report()
      }

      /*  Handle Address autocomplete */

      function on_place_changed() {
        var place = auto_complete.getPlace();
        var location = place.geometry.location;

        //  Move map

        map.panTo(location);

        //  Show marker

        var marker = set_marker(location);

        //  Show info popup

        set_info_window(marker, compose_address(place.address_components));

        //  Show coordinates

        var lat = round(location.lat(), 4);
        var lng = round(location.lng(), 4);
        document.getElementById("l_latlng").innerHTML = lat + ", " + lng;

        //  Show the report

        console.log(location)
        criteria.loc = location;
        get_report()
      }

      /*  Handle criteria button press */

      function on_select(setting, value) {
        if (criteria[setting] != value) {
          if (criteria[setting] != null) {
            set_active("#" + setting + criteria[setting], false)
          }
          set_active("#" + setting + value, true);
          criteria[setting] = value
          get_report()
        }
      }

      /*  Handle window resize */

      function on_resize() {
        if (hist_svg != null) {
          redraw({ data : report, duration : 0 })
        }
      }

      /*  Handle report button */

      function on_get_report() {
        get_report();
      }

      /*  (Re)draw price chart */

      function redraw(options) {
        _.defaults(options, { duration : 250 });

        var listings = options.data.listings;
        var prediction = options.data.prediction;
        var duration = options.duration;

        //  Chart

        var hist_params = { 
          margin : { top: 0, left: 0, bottom: 30, right: 30 },
          height : 200
        };

        if (hist_svg == null) {
          hist_svg = d3.select("#hist")
          .append("svg")
            .attr("width", "100%")
            .attr("height", hist_params.height + hist_params.margin.top + hist_params.margin.bottom)
          .append("g")
            .attr("transform", "translate(" + hist_params.margin.left + "," + hist_params.margin.top + ")");
        }

        var element = document.getElementById("hist");
        var width = element.offsetWidth - (hist_params.margin.left + hist_params.margin.right);
        var height = element.offsetHeight - (hist_params.margin.top + hist_params.margin.bottom);

        //  Chart: bars

        var xMin = 600;
        var xMax = 10000
        var x = d3.scaleLinear()
          .domain([xMin, xMax])
          .rangeRound([0, width]);

        var bins = d3.histogram()
          .domain(x.domain())
          .thresholds(d3.range(xMin, xMax, 200))
          (listings.map(function(d) { return d.price; }));

        var y = d3.scaleLinear()
          .domain([0, d3.max(bins, function(d) { return d.length; })])
          .range([height, 0]);

        var bar = hist_svg.selectAll(".bar")
          .data(bins)
        .enter().append("g")
          .attr("class", "bar")
        .append("rect")
          .attr("x", 1);

        bar.exit().remove();

        hist_svg.selectAll("g")
          .data(bins)
          .transition().duration(duration)
          .attr("transform", function(d) { return "translate(" + x(d.x0) + "," + y(d.length) + ")"});

        hist_svg.selectAll("rect")
          .data(bins)
          .transition().duration(duration)
          .attr("width", function(d) { return x(d.x1) - x(d.x0) - 1; })
          .attr("height", function(d) { return height - y(d.length); });

        //  Chart: plot

        hist_svg.selectAll("path")
          .data([null])
          .enter().append("path")
          .attr("class", "line")
          .attr("style", "opacity:0;");

        if (listings.length > 0 && !listings[0].pdf) {
          hist_svg.select("path")
            .attr("style", "opacity:0;");
        } else {
          var yPDF = d3.scaleLinear()
            .domain([0, 1.01 * d3.max(listings, function(d) { return d.pdf; })])
            .range([height, 0]);

          hist_svg.select("path")
            .datum(listings)
            .attr('d', d3.line()
              .curve(d3.curveBasis)
              .x(function(d) { return x(d.price); })
              .y(function(d) { return yPDF(d.pdf); })
              )
            .transition().duration(duration)
            .attr("style", "opacity:1;");
        }

        //  Chart: axis

        hist_svg.selectAll(".axis")
          .data([null])
          .enter().append("g")
          .attr("class", "axis axis--x");

        hist_svg.select(".axis")
          .attr("transform", "translate(0," + height + ")")
          .transition().duration(duration)
          .call(d3.axisBottom(x));

        //  Rent meter

        var meter_params = {
          margin : { top: 5, left: 0, bottom: 5, right: 0},
          height : 30
        }
        width = document.getElementById("meter").offsetWidth;
        height = meter_params.height + meter_params.margin.top + meter_params.margin.bottom;
        margin = meter_params.margin;

        if (meter_svg == null) {
          meter_svg = d3.select("#meter")
          .append("svg")
            .attr("width",  width)
            .attr("height", height)
          .append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.right + ")");

          meter_svg.append("g")
            .attr("class", "axis axis--grid")
            .attr("transform", "translate(0," + (meter_params.height + margin.top) + ")")
            .call(d3.axisBottom(x)
                .ticks(d3.range(xMin, xMax, 200))
                .tickSize(-meter_params.height)
                .tickFormat(function() { return null; }));
          // .selectAll(".tick")
          //   .classed("tick--minor", function(d) { return d.getHours(); });

          meter_svg.append("rect")
            .attr("rx", 0)
            .attr("ry", 0)
            .attr("x", 0)
            .attr("y", 0)
            .attr("width", 0)
            .attr("height", height)
            .attr("opacity", 0.5)
            .style("fill", "darkorange")
        }

        meter_svg.selectAll("rect")
          .data([prediction])
          .transition().duration(duration)
          .attr("x", function(d) { return x(d.predict - d.std); })
          .attr("width", function(d) { return x(2 * d.std) - x(0); })
      }

      /*  Helper functions */

      /*  Compose address for info popup */

      function compose_address(components) {
        function get_component(index) {
          if (components[index] && components[index].short_name) {
            return components[index].short_name;
          } else {
            return "";
          }
        }
        return [[get_component(0), get_component(1)].join(" "), get_component(2)].join(", ") 
      }

      /*  Activate/Deactivate a button */

      function set_active(id, active) {
        d3.select(id)
          .attr("class", active ? "btn btn-primary active" : "btn btn-secondary")
          .attr("aria-pressed", active ? "true" : "false")
      }

      /*  Show/move map marker */

      function set_marker(loc) {
        if (marker == null) {
          marker = new google.maps.Marker({ map: map, position: loc });
        } else {
          marker.setPosition(loc)
        }
        if (circle == null) {
          circle_params.map = map;
          circle_params.center = loc;
          circle_params.radius = 500;
          circle = new google.maps.Circle(circle_params);
        } else {
          circle.setCenter(loc);
        }
        return marker;
      }

      /*  Set info window text and location */

      function set_info_window(marker, text) {
        if (text) {
          if (!info_window) {
            info_window = new google.maps.InfoWindow;
          }
          info_window.setContent(text);
          info_window.open(map, marker);
        } else if (info_window) {
          info_window.close();
        }
      }

      /*  Get Google Geocoder */

      function get_geocoder() {
        if (geocoder == null) {
          geocoder = new google.maps.Geocoder();
        }
        return geocoder;        
      }

      /*  Run report */

      function get_report() {
        var args = { 
          "latitude": round(criteria.loc.lat(), 4), 
          "longitude": round(criteria.loc.lng(), 4)
        }
        if (criteria.br) {
          args["bedrooms"] = parseInt(criteria.br)
        }
        if (criteria.ba) {
          args["bathrooms"] = parseFloat(criteria.ba.replace("_", "."))
        }
        console.log("POST", args);

        $.ajax({
          type: "POST",
          contentType: "application/json; charset=utf-8",
          url: "/submit",
          dataType: "json",
          async: true,
          data: JSON.stringify(args),
          success: function (data) {
            document.getElementById('l_matches').innerHTML = data.listings.length + " matches";
            redraw({data : data});
            report = data;
          },
          error: function (result) {
            console.log("error:", result);
          }
        });
      }

      /*  Round floating point number to X digits */

      function round(number, digits) {
        var multiplier = Math.pow(10, digits);
        return Math.round(number * multiplier) / multiplier;
      }

    </script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAF8ua0oB76VvlorpKIFHv4y8V7Fa_fgtE&language=en&libraries=places&callback=init"
    async defer>
    </script>
  </body>
